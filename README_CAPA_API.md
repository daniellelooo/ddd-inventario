# üåê CAPA API - InventarioDDD.API

## üìã √çndice

- [Descripci√≥n General](#descripci√≥n-general)
- [Responsabilidades](#responsabilidades)
- [Estructura de Archivos](#estructura-de-archivos)
- [Archivos Principales](#archivos-principales)
- [Controllers (Controladores)](#controllers-controladores)
- [Middleware](#middleware)
- [Configuraci√≥n](#configuraci√≥n)

---

## Descripci√≥n General

La **Capa API** es la capa m√°s externa de la aplicaci√≥n y act√∫a como punto de entrada para todas las peticiones HTTP. Esta capa expone endpoints RESTful que permiten a los clientes (como el frontend React) interactuar con el sistema de inventario.

### Tecnolog√≠as Utilizadas

- **.NET 9** (ASP.NET Core)
- **MediatR** - Para implementar el patr√≥n Mediator
- **Swagger/OpenAPI** - Para documentaci√≥n de API
- **Entity Framework Core** - ORM para acceso a datos

---

## Responsabilidades

1. **Recibir peticiones HTTP** desde clientes externos
2. **Validar datos de entrada** b√°sicos (formato, tipos)
3. **Enrutar peticiones** a los handlers correspondientes mediante MediatR
4. **Serializar/Deserializar** objetos JSON
5. **Manejar errores** y devolver respuestas HTTP apropiadas
6. **Implementar CORS** para permitir acceso desde el frontend
7. **Documentar endpoints** con Swagger

> **Nota Importante**: Esta capa NO contiene l√≥gica de negocio. Solo coordina y delega responsabilidades.

---

## Estructura de Archivos

```
InventarioDDD.API/
‚îÇ
‚îú‚îÄ‚îÄ Controllers/              # Controladores REST
‚îÇ   ‚îú‚îÄ‚îÄ CategoriasController.cs
‚îÇ   ‚îú‚îÄ‚îÄ IngredientesController.cs
‚îÇ   ‚îú‚îÄ‚îÄ InventarioController.cs
‚îÇ   ‚îú‚îÄ‚îÄ LotesController.cs
‚îÇ   ‚îú‚îÄ‚îÄ OrdenesCompraController.cs
‚îÇ   ‚îî‚îÄ‚îÄ ProveedoresController.cs
‚îÇ
‚îú‚îÄ‚îÄ Middleware/               # Middleware personalizado
‚îÇ   ‚îî‚îÄ‚îÄ ExceptionHandlingMiddleware.cs
‚îÇ
‚îú‚îÄ‚îÄ Properties/
‚îÇ   ‚îî‚îÄ‚îÄ launchSettings.json   # Configuraci√≥n de inicio
‚îÇ
‚îú‚îÄ‚îÄ Program.cs                # Punto de entrada y configuraci√≥n
‚îú‚îÄ‚îÄ appsettings.json          # Configuraci√≥n de la aplicaci√≥n
‚îî‚îÄ‚îÄ InventarioDDD.API.csproj  # Archivo de proyecto
```

---

## Archivos Principales

### üìÑ Program.cs

**Prop√≥sito**: Punto de entrada de la aplicaci√≥n. Configura todos los servicios y el pipeline de middleware.

**Responsabilidades**:

1. **Configuraci√≥n de Servicios**:

   - Registra MediatR para CQRS
   - Configura DbContext con SQLite
   - Registra repositorios (Dependency Injection)
   - Configura Swagger para documentaci√≥n

2. **Configuraci√≥n del Pipeline HTTP**:
   - Habilita Swagger en desarrollo
   - Configura CORS para permitir peticiones del frontend
   - Agrega middleware de manejo de excepciones
   - Configura enrutamiento de controladores

**C√≥digo Clave**:

```csharp
// Registro de MediatR (Patr√≥n Mediator para CQRS)
builder.Services.AddMediatR(cfg => {
    cfg.RegisterServicesFromAssembly(typeof(CrearIngredienteHandler).Assembly);
});

// Configuraci√≥n de DbContext con SQLite
builder.Services.AddDbContext<InventarioDbContext>(options =>
    options.UseSqlite(builder.Configuration.GetConnectionString("DefaultConnection")));

// Registro de Repositorios (Dependency Injection)
builder.Services.AddScoped<IIngredienteRepository, IngredienteRepository>();
builder.Services.AddScoped<IOrdenDeCompraRepository, OrdenDeCompraRepository>();
// ... otros repositorios

// Configuraci√≥n de CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll",
        builder => builder.AllowAnyOrigin()
                         .AllowAnyMethod()
                         .AllowAnyHeader());
});
```

**Flujo de Configuraci√≥n**:

```
Inicio ‚Üí Configurar Servicios ‚Üí Construir App ‚Üí
Configurar Pipeline ‚Üí Ejecutar Migraciones ‚Üí Iniciar Servidor
```

---

### üìÑ appsettings.json

**Prop√≥sito**: Almacena la configuraci√≥n de la aplicaci√≥n.

**Contenido Principal**:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=Inventario.db"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

**Configuraciones Clave**:

- **ConnectionStrings**: Cadena de conexi√≥n a la base de datos SQLite
- **Logging**: Niveles de log para diferentes componentes

---

## Controllers (Controladores)

Los controladores son clases que exponen endpoints HTTP. Cada controlador maneja un conjunto de operaciones relacionadas con una entidad del dominio.

### üéÆ Patr√≥n Com√∫n de Controladores

Todos los controladores siguen este patr√≥n:

1. **Heredan de `ControllerBase`**
2. **Usan `[ApiController]` y `[Route]`** para configuraci√≥n autom√°tica
3. **Inyectan `IMediator`** en el constructor
4. **Delegan operaciones** a handlers mediante MediatR
5. **Devuelven `IActionResult`** con c√≥digos HTTP apropiados

**Estructura T√≠pica**:

```csharp
[ApiController]
[Route("api/[controller]")]
public class NombreController : ControllerBase
{
    private readonly IMediator _mediator;

    public NombreController(IMediator mediator)
    {
        _mediator = mediator;
    }

    [HttpGet]
    public async Task<IActionResult> Get()
    {
        var result = await _mediator.Send(new Query());
        return Ok(result);
    }

    [HttpPost]
    public async Task<IActionResult> Create([FromBody] Command command)
    {
        var result = await _mediator.Send(command);
        return CreatedAtAction(nameof(Get), new { id = result.Id }, result);
    }
}
```

---

### üìÅ IngredientesController.cs

**Prop√≥sito**: Gestiona las operaciones relacionadas con ingredientes.

**Endpoints**:

| M√©todo | Ruta                            | Descripci√≥n                         | Handler Usado                             |
| ------ | ------------------------------- | ----------------------------------- | ----------------------------------------- |
| GET    | `/api/ingredientes`             | Obtiene todos los ingredientes      | Query directo al repositorio              |
| GET    | `/api/ingredientes/{id}`        | Obtiene un ingrediente por ID       | Query al repositorio                      |
| GET    | `/api/ingredientes/reabastecer` | Obtiene ingredientes con stock bajo | `ObtenerIngredientesParaReabastecerQuery` |
| POST   | `/api/ingredientes`             | Crea un nuevo ingrediente           | `CrearIngredienteCommand`                 |

**Ejemplo de Endpoint**:

```csharp
[HttpGet("reabastecer")]
public async Task<IActionResult> GetParaReabastecer()
{
    var query = new ObtenerIngredientesParaReabastecerQuery();
    var resultado = await _mediator.Send(query);
    return Ok(resultado);
}
```

**Flujo de una Petici√≥n**:

```
Cliente ‚Üí GET /api/ingredientes/reabastecer ‚Üí IngredientesController
‚Üí _mediator.Send(Query) ‚Üí ObtenerIngredientesParaReabastecerHandler
‚Üí Ejecuta l√≥gica ‚Üí Retorna DTOs ‚Üí Controller ‚Üí JSON Response
```

**Validaciones**:

- Los datos de entrada se validan autom√°ticamente por `[ApiController]`
- Las validaciones de negocio est√°n en los handlers

---

### üìÅ OrdenesCompraController.cs

**Prop√≥sito**: Gestiona el ciclo de vida completo de las √≥rdenes de compra.

**Endpoints**:

| M√©todo | Ruta                              | Descripci√≥n                   | Handler Usado                   |
| ------ | --------------------------------- | ----------------------------- | ------------------------------- |
| GET    | `/api/ordenescompra`              | Obtiene todas las √≥rdenes     | Query al repositorio            |
| GET    | `/api/ordenescompra/pendientes`   | Obtiene √≥rdenes pendientes    | `ObtenerOrdenesPendientesQuery` |
| POST   | `/api/ordenescompra`              | Crea una nueva orden          | `CrearOrdenDeCompraCommand`     |
| POST   | `/api/ordenescompra/{id}/aprobar` | Aprueba una orden             | `AprobarOrdenDeCompraCommand`   |
| POST   | `/api/ordenescompra/{id}/recibir` | Recibe una orden y crea lotes | `RecibirOrdenDeCompraCommand`   |

**Ejemplo - Aprobar Orden**:

```csharp
[HttpPost("{id}/aprobar")]
public async Task<IActionResult> Aprobar(
    Guid id,
    [FromBody] AprobarOrdenRequest request)
{
    var command = new AprobarOrdenDeCompraCommand
    {
        OrdenId = id,
        UsuarioId = request.UsuarioId
    };

    await _mediator.Send(command);
    return Ok(new { message = "Orden aprobada exitosamente" });
}
```

**Flujo Completo de una Orden**:

```
1. POST /ordenescompra ‚Üí CrearOrdenDeCompraCommand
   ‚îî‚îÄ> Estado: Pendiente

2. POST /ordenescompra/{id}/aprobar ‚Üí AprobarOrdenDeCompraCommand
   ‚îî‚îÄ> Estado: Aprobada

3. POST /ordenescompra/{id}/recibir ‚Üí RecibirOrdenDeCompraCommand
   ‚îî‚îÄ> Estado: Recibida
   ‚îî‚îÄ> Crea Lotes autom√°ticamente
   ‚îî‚îÄ> Actualiza Stock del Ingrediente
```

---

### üìÅ InventarioController.cs

**Prop√≥sito**: Gestiona operaciones de inventario como consumo y movimientos.

**Endpoints**:

| M√©todo | Ruta                                    | Descripci√≥n                      | Handler Usado                      |
| ------ | --------------------------------------- | -------------------------------- | ---------------------------------- |
| POST   | `/api/inventario/consumo`               | Registra consumo de ingrediente  | `RegistrarConsumoCommand`          |
| GET    | `/api/inventario/movimientos`           | Obtiene historial de movimientos | `ObtenerHistorialMovimientosQuery` |
| GET    | `/api/inventario/lotes/proximos-vencer` | Obtiene lotes pr√≥ximos a vencer  | `ObtenerLotesProximosAVencerQuery` |

**Ejemplo - Registrar Consumo**:

```csharp
[HttpPost("consumo")]
public async Task<IActionResult> RegistrarConsumo(
    [FromBody] RegistrarConsumoCommand command)
{
    await _mediator.Send(command);
    return Ok(new { message = "Consumo registrado exitosamente" });
}
```

**Flujo de Registro de Consumo**:

```
Cliente ‚Üí POST /api/inventario/consumo
‚Üí RegistrarConsumoCommand { ingredienteId, cantidad, motivo }
‚Üí RegistrarConsumoHandler
‚Üí Aplica FIFO en lotes
‚Üí Reduce stock disponible
‚Üí Crea MovimientoInventario
‚Üí Retorna √©xito
```

---

### üìÅ LotesController.cs

**Prop√≥sito**: Gestiona la consulta de lotes de ingredientes.

**Endpoints**:

| M√©todo | Ruta                                     | Descripci√≥n                     |
| ------ | ---------------------------------------- | ------------------------------- |
| GET    | `/api/lotes`                             | Obtiene todos los lotes         |
| GET    | `/api/lotes/{id}`                        | Obtiene un lote por ID          |
| GET    | `/api/lotes/ingrediente/{ingredienteId}` | Obtiene lotes de un ingrediente |

**Caracter√≠sticas**:

- Solo permite consultas (GET)
- Los lotes se crean autom√°ticamente al recibir √≥rdenes de compra
- No hay endpoints POST/PUT/DELETE directos

---

### üìÅ ProveedoresController.cs

**Prop√≥sito**: Gestiona operaciones CRUD de proveedores.

**Endpoints**:

| M√©todo | Ruta                    | Descripci√≥n                   | Handler Usado           |
| ------ | ----------------------- | ----------------------------- | ----------------------- |
| GET    | `/api/proveedores`      | Obtiene todos los proveedores | Query al repositorio    |
| GET    | `/api/proveedores/{id}` | Obtiene un proveedor por ID   | Query al repositorio    |
| POST   | `/api/proveedores`      | Crea un nuevo proveedor       | `CrearProveedorCommand` |

---

### üìÅ CategoriasController.cs

**Prop√≥sito**: Gestiona operaciones CRUD de categor√≠as de ingredientes.

**Endpoints**:

| M√©todo | Ruta                   | Descripci√≥n                  | Handler Usado           |
| ------ | ---------------------- | ---------------------------- | ----------------------- |
| GET    | `/api/categorias`      | Obtiene todas las categor√≠as | Query al repositorio    |
| GET    | `/api/categorias/{id}` | Obtiene una categor√≠a por ID | Query al repositorio    |
| POST   | `/api/categorias`      | Crea una nueva categor√≠a     | `CrearCategoriaCommand` |

---

## Middleware

### üõ°Ô∏è ExceptionHandlingMiddleware.cs

**Prop√≥sito**: Captura y maneja todas las excepciones de la aplicaci√≥n de forma centralizada.

**Responsabilidades**:

1. Capturar excepciones no controladas
2. Loggear errores con detalles
3. Devolver respuestas HTTP apropiadas
4. Evitar exponer detalles internos al cliente

**Funcionamiento**:

```csharp
public class ExceptionHandlingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<ExceptionHandlingMiddleware> _logger;

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context); // Ejecuta el siguiente middleware
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error no controlado");
            await HandleExceptionAsync(context, ex);
        }
    }

    private static Task HandleExceptionAsync(HttpContext context, Exception exception)
    {
        context.Response.ContentType = "application/json";
        context.Response.StatusCode = (int)HttpStatusCode.InternalServerError;

        var response = new
        {
            message = "Ha ocurrido un error interno",
            details = exception.Message
        };

        return context.Response.WriteAsync(JsonSerializer.Serialize(response));
    }
}
```

**Tipos de Excepciones Manejadas**:

- `InvalidOperationException` ‚Üí 400 Bad Request
- `ArgumentException` ‚Üí 400 Bad Request
- `KeyNotFoundException` ‚Üí 404 Not Found
- `Exception` (gen√©rica) ‚Üí 500 Internal Server Error

**Registro en Program.cs**:

```csharp
app.UseMiddleware<ExceptionHandlingMiddleware>();
```

---

## Configuraci√≥n

### üîß CORS (Cross-Origin Resource Sharing)

**Prop√≥sito**: Permitir que el frontend (React en puerto 3000) haga peticiones a la API (puerto 5261).

**Configuraci√≥n**:

```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll",
        builder => builder
            .AllowAnyOrigin()    // Permite cualquier origen
            .AllowAnyMethod()    // Permite GET, POST, PUT, DELETE, etc.
            .AllowAnyHeader());  // Permite cualquier header
});

// En el pipeline
app.UseCors("AllowAll");
```

> **Nota de Seguridad**: En producci√≥n, deber√≠as especificar or√≠genes espec√≠ficos en lugar de `AllowAnyOrigin()`.

---

### üìö Swagger/OpenAPI

**Prop√≥sito**: Genera documentaci√≥n interactiva de la API.

**Configuraci√≥n**:

```csharp
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// En el pipeline (solo en desarrollo)
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}
```

**Acceso**: http://localhost:5261/swagger

**Caracter√≠sticas**:

- Documentaci√≥n autom√°tica de todos los endpoints
- Permite probar endpoints directamente desde el navegador
- Muestra modelos de datos de entrada/salida

---

## Flujo de una Petici√≥n HTTP Completo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Cliente (Frontend React)                                ‚îÇ
‚îÇ    POST http://localhost:5261/api/ingredientes             ‚îÇ
‚îÇ    Body: { "nombre": "Tomate", ... }                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Pipeline de Middleware                                   ‚îÇ
‚îÇ    ‚îú‚îÄ CORS Middleware (valida origen)                      ‚îÇ
‚îÇ    ‚îú‚îÄ ExceptionHandlingMiddleware (try/catch global)       ‚îÇ
‚îÇ    ‚îî‚îÄ Routing Middleware (encuentra el controller)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. IngredientesController                                   ‚îÇ
‚îÇ    [HttpPost]                                               ‚îÇ
‚îÇ    public async Task<IActionResult> Create(Command cmd)     ‚îÇ
‚îÇ    {                                                         ‚îÇ
‚îÇ        var result = await _mediator.Send(cmd);             ‚îÇ
‚îÇ        return CreatedAtAction(...);                         ‚îÇ
‚îÇ    }                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. MediatR (Patr√≥n Mediator)                               ‚îÇ
‚îÇ    Encuentra el Handler correspondiente al Command         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. CrearIngredienteHandler (Capa Application)              ‚îÇ
‚îÇ    - Valida datos                                           ‚îÇ
‚îÇ    - Crea entidad de dominio                                ‚îÇ
‚îÇ    - Llama al repositorio                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. IngredienteRepository (Capa Infrastructure)             ‚îÇ
‚îÇ    - Guarda en base de datos                                ‚îÇ
‚îÇ    - Retorna entidad guardada                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. Retorno al Controller                                    ‚îÇ
‚îÇ    return CreatedAtAction(..., resultado);                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. Respuesta HTTP                                           ‚îÇ
‚îÇ    Status: 201 Created                                      ‚îÇ
‚îÇ    Body: { "id": "...", "nombre": "Tomate", ... }         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Ventajas de esta Arquitectura

### ‚úÖ Separation of Concerns

Cada capa tiene una responsabilidad clara:

- **API**: Recibir/enviar HTTP
- **Application**: L√≥gica de aplicaci√≥n y orquestaci√≥n
- **Infrastructure**: Persistencia y servicios externos

### ‚úÖ Patr√≥n Mediator (MediatR)

- Desacopla controllers de handlers
- Facilita testing
- Permite agregar comportamientos transversales (logging, validaci√≥n)

### ‚úÖ Manejo de Errores Centralizado

- Un solo lugar para manejar excepciones
- Respuestas consistentes
- Logging autom√°tico

### ‚úÖ Documentaci√≥n Autom√°tica (Swagger)

- Documentaci√≥n siempre actualizada
- Facilita testing manual
- Ayuda a frontend a consumir la API

---

## C√≥digos HTTP Utilizados

| C√≥digo                    | Significado         | Cu√°ndo se Usa           |
| ------------------------- | ------------------- | ----------------------- |
| 200 OK                    | √âxito               | GET, PUT exitosos       |
| 201 Created               | Recurso creado      | POST exitoso            |
| 204 No Content            | √âxito sin contenido | DELETE exitoso          |
| 400 Bad Request           | Datos inv√°lidos     | Validaci√≥n fallida      |
| 404 Not Found             | Recurso no existe   | GET de ID inexistente   |
| 500 Internal Server Error | Error del servidor  | Excepci√≥n no controlada |

---

---

## üìä CRITERIOS DE EVALUACI√ìN - CAPA PRESENTACI√ìN (API)

### ‚úÖ 1. Controllers Delgados (Thin Controllers)

**Criterio**: Controllers delgados que implementan los casos de uso

**Implementaci√≥n**:

```csharp
[ApiController]
[Route("api/[controller]")]
public class IngredientesController : ControllerBase
{
    private readonly IMediator _mediator;
    
    public IngredientesController(IMediator mediator)
    {
        _mediator = mediator;
    }
    
    // ‚úÖ CONTROLLER DELGADO: Solo coordina, no tiene l√≥gica
    [HttpPost]
    public async Task<ActionResult<IngredienteDto>> Crear([FromBody] CrearIngredienteCommand command)
    {
        // 1. Recibe el comando
        // 2. Delega a MediatR (que ejecuta el Handler)
        var resultado = await _mediator.Send(command);
        
        // 3. Retorna respuesta HTTP
        return CreatedAtAction(nameof(ObtenerPorId), new { id = resultado.Id }, resultado);
    }
}
```

**¬øQu√© NO hace el Controller?**
- ‚ùå NO valida reglas de negocio
- ‚ùå NO accede directamente a la base de datos
- ‚ùå NO contiene l√≥gica de dominio
- ‚ùå NO hace c√°lculos complejos
- ‚ùå NO coordina m√∫ltiples operaciones

**¬øQu√© S√ç hace el Controller?**
- ‚úÖ Recibe datos del HTTP request
- ‚úÖ Delega a MediatR
- ‚úÖ Retorna respuestas HTTP apropiadas
- ‚úÖ Maneja routing y verbos HTTP

**Ejemplo de Controller GRUESO (incorrecto)**:
```csharp
// ‚ùå MAL - Controller con l√≥gica de negocio
[HttpPost]
public async Task<ActionResult> CrearIncorrecto([FromBody] IngredienteDto dto)
{
    // ‚ùå L√≥gica de negocio en el controller
    if (dto.StockMinimo > dto.StockMaximo)
        return BadRequest("Stock m√≠nimo debe ser menor al m√°ximo");
    
    // ‚ùå Acceso directo a la BD
    _context.Ingredientes.Add(new Ingrediente { ... });
    await _context.SaveChangesAsync();
    
    // ‚ùå L√≥gica de c√°lculo
    var valorInventario = dto.CantidadEnStock * dto.PrecioUnitario;
    
    return Ok();
}
```

**Conclusi√≥n**: ‚úÖ **CUMPLE** - Todos los controllers son delgados y solo coordinan.

---

### ‚úÖ 2. Manejan Consistencia (Commits, Rollbacks)

**Criterio**: Controllers manejan commits y rollbacks de transacciones

**Implementaci√≥n**:

**Forma 1: Transacciones Impl√≠citas (Autom√°ticas)**
```csharp
[HttpPost("recibir")]
public async Task<ActionResult<OrdenDeCompraDto>> RecibirOrden(
    [FromBody] RecibirOrdenDeCompraCommand command)
{
    // ‚úÖ MediatR + EF Core manejan transacciones autom√°ticamente
    var resultado = await _mediator.Send(command);
    
    // Si todo va bien: COMMIT autom√°tico
    // Si hay excepci√≥n: ROLLBACK autom√°tico
    
    return Ok(resultado);
}
```

**Forma 2: Manejo de Errores con Middleware**
```csharp
// ExceptionHandlingMiddleware.cs
public async Task InvokeAsync(HttpContext context, RequestDelegate next)
{
    try
    {
        // ‚úÖ Ejecuta el request
        await next(context);
        // Si llega aqu√≠: COMMIT exitoso
    }
    catch (InvalidOperationException ex)
    {
        // ‚úÖ Si hay excepci√≥n: ROLLBACK autom√°tico
        context.Response.StatusCode = 400;
        await context.Response.WriteAsJsonAsync(new { error = ex.Message });
    }
    catch (Exception ex)
    {
        // ‚úÖ Cualquier error: ROLLBACK
        context.Response.StatusCode = 500;
        await context.Response.WriteAsJsonAsync(new { error = "Error interno" });
    }
}
```

**Flujo de Transacci√≥n**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Controller recibe request                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. _mediator.Send(command)                   ‚îÇ
‚îÇ    ‚Üí Handler ejecuta l√≥gica                  ‚îÇ
‚îÇ    ‚Üí Llama a repositorios                    ‚îÇ
‚îÇ    ‚Üí EF Core inicia transacci√≥n impl√≠cita    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. SaveChangesAsync()                        ‚îÇ
‚îÇ    ‚úÖ √âxito ‚Üí COMMIT                         ‚îÇ
‚îÇ    ‚ùå Error ‚Üí ROLLBACK                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Controller retorna respuesta HTTP         ‚îÇ
‚îÇ    200/201 si √©xito                          ‚îÇ
‚îÇ    400/500 si error                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Ejemplo con Transacciones Expl√≠citas** (si se requiere):
```csharp
[HttpPost("operacion-compleja")]
public async Task<ActionResult> OperacionCompleja([FromBody] ComandoComplejo command)
{
    using (var transaction = await _context.Database.BeginTransactionAsync())
    {
        try
        {
            // M√∫ltiples operaciones
            var resultado1 = await _mediator.Send(command.Parte1);
            var resultado2 = await _mediator.Send(command.Parte2);
            
            // ‚úÖ COMMIT expl√≠cito
            await transaction.CommitAsync();
            
            return Ok();
        }
        catch (Exception)
        {
            // ‚úÖ ROLLBACK expl√≠cito
            await transaction.RollbackAsync();
            throw;
        }
    }
}
```

**Conclusi√≥n**: ‚úÖ **CUMPLE** - Las transacciones se manejan autom√°ticamente con EF Core, garantizando consistencia.

---

### ‚úÖ 3. DTOs para Entrada/Salida

**Criterio**: Implementa DTOs para transportar datos entre capas

**Implementaci√≥n**:

**DTOs en la Capa Application** (`InventarioDDD.Application/DTOs/`):

```csharp
// IngredienteDto.cs
public class IngredienteDto
{
    public Guid Id { get; set; }
    public string Nombre { get; set; }
    public string Descripcion { get; set; }
    public string UnidadDeMedida { get; set; }
    public decimal CantidadEnStock { get; set; }
    public decimal StockMinimo { get; set; }
    public decimal StockMaximo { get; set; }
    public Guid CategoriaId { get; set; }
}

// OrdenDeCompraDto.cs
public class OrdenDeCompraDto
{
    public Guid Id { get; set; }
    public string Numero { get; set; }
    public string IngredienteNombre { get; set; }
    public string ProveedorNombre { get; set; }
    public decimal Cantidad { get; set; }
    public decimal PrecioUnitario { get; set; }
    public string Estado { get; set; }
    public DateTime FechaCreacion { get; set; }
}
```

**Uso en Controllers**:
```csharp
[HttpGet]
public async Task<ActionResult<List<IngredienteDto>>> ObtenerTodos()
{
    var query = new ObtenerTodosIngredientesQuery();
    
    // ‚úÖ Handler retorna DTOs, NO entidades del dominio
    var ingredientes = await _mediator.Send(query);
    
    return Ok(ingredientes);
}

[HttpPost]
public async Task<ActionResult<IngredienteDto>> Crear([FromBody] CrearIngredienteCommand command)
{
    // ‚úÖ Recibe Command (que es como un DTO de entrada)
    // ‚úÖ Retorna DTO (no entidad de dominio)
    var resultado = await _mediator.Send(command);
    
    return CreatedAtAction(nameof(ObtenerPorId), new { id = resultado.Id }, resultado);
}
```

**Separaci√≥n Entidad vs DTO**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Entidad (Domain)      ‚îÇ       ‚îÇ   DTO (Application)      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - Tiene l√≥gica          ‚îÇ       ‚îÇ - Solo datos             ‚îÇ
‚îÇ - Protege invariantes   ‚îÇ       ‚îÇ - Sin m√©todos            ‚îÇ
‚îÇ - Constructores privados‚îÇ       ‚îÇ - Getters/Setters        ‚îÇ
‚îÇ - M√©todos de negocio    ‚îÇ       ‚îÇ - Serializable JSON      ‚îÇ
‚îÇ - Value Objects         ‚îÇ       ‚îÇ - Propiedades simples    ‚îÇ
‚îÇ                         ‚îÇ       ‚îÇ                          ‚îÇ
‚îÇ NO se expone en API     ‚îÇ       ‚îÇ S√ç se expone en API      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Conclusi√≥n**: ‚úÖ **CUMPLE** - Todos los endpoints usan DTOs, nunca exponen entidades del dominio.

---

### ‚úÖ 4. Mapeo Expl√≠cito Hacia/Desde el Modelo de Dominio

**Criterio**: Mapeo expl√≠cito entre DTOs y entidades de dominio

**Implementaci√≥n en Handlers**:

```csharp
// CrearIngredienteHandler.cs
public class CrearIngredienteHandler : IRequestHandler<CrearIngredienteCommand, IngredienteDto>
{
    public async Task<IngredienteDto> Handle(CrearIngredienteCommand request, ...)
    {
        // 1. ‚úÖ MAPEO: Command ‚Üí Value Objects del Domain
        var unidadDeMedida = new UnidadDeMedida(request.UnidadDeMedida);
        var rangoDeStock = new RangoDeStock(request.StockMinimo, request.StockMaximo);
        
        // 2. ‚úÖ CREAR: Entidad del Domain
        var ingrediente = new Ingrediente(
            request.Nombre,
            request.Descripcion,
            unidadDeMedida,
            rangoDeStock,
            request.CategoriaId
        );
        
        // 3. Persistir
        var aggregate = new IngredienteAggregate(ingrediente);
        await _ingredienteRepository.GuardarAsync(aggregate);
        
        // 4. ‚úÖ MAPEO: Entidad ‚Üí DTO
        return new IngredienteDto
        {
            Id = ingrediente.Id,
            Nombre = ingrediente.Nombre,
            Descripcion = ingrediente.Descripcion,
            UnidadDeMedida = ingrediente.UnidadDeMedida.Simbolo,
            CantidadEnStock = ingrediente.CantidadEnStock.Valor,
            StockMinimo = ingrediente.RangoDeStock.StockMinimo,
            StockMaximo = ingrediente.RangoDeStock.StockMaximo,
            CategoriaId = ingrediente.CategoriaId
        };
    }
}
```

**Ejemplo de Mapeo Complejo**:
```csharp
// ObtenerIngredientesHandler.cs
private IngredienteDto MapToDto(Ingrediente ingrediente)
{
    return new IngredienteDto
    {
        // ‚úÖ Mapeo expl√≠cito de cada campo
        Id = ingrediente.Id,
        Nombre = ingrediente.Nombre,
        Descripcion = ingrediente.Descripcion,
        
        // ‚úÖ Desempaqueta Value Objects
        UnidadDeMedida = ingrediente.UnidadDeMedida.Simbolo,
        CantidadEnStock = ingrediente.CantidadEnStock.Valor,
        StockMinimo = ingrediente.RangoDeStock.StockMinimo,
        StockMaximo = ingrediente.RangoDeStock.StockMaximo,
        
        CategoriaId = ingrediente.CategoriaId,
        FechaCreacion = ingrediente.FechaCreacion
    };
}
```

**Lo que NO se hace**:
```csharp
// ‚ùå INCORRECTO - Exponer entidades directamente
[HttpGet("{id}")]
public async Task<Ingrediente> ObtenerPorId(Guid id)
{
    return await _context.Ingredientes.FindAsync(id); // ‚ùå Expone entidad
}

// ‚ùå INCORRECTO - Sin mapeo expl√≠cito
public IngredienteDto AutoMapper(Ingrediente ingrediente)
{
    return _mapper.Map<IngredienteDto>(ingrediente); // ‚ùå Mapeo impl√≠cito/m√°gico
}
```

**Conclusi√≥n**: ‚úÖ **CUMPLE** - Todos los handlers tienen mapeo expl√≠cito entre entidades y DTOs.

---

### ‚úÖ 5. Validaci√≥n de Datos en el Punto de Recepci√≥n (Boundaries)

**Criterio**: Validaci√≥n de datos de entrada en controllers/boundaries

**Implementaci√≥n**:

**Nivel 1: Validaci√≥n de ASP.NET Core (Autom√°tica)**
```csharp
// Command con Data Annotations
public class CrearIngredienteCommand : IRequest<IngredienteDto>
{
    [Required(ErrorMessage = "El nombre es requerido")]
    [StringLength(100, MinimumLength = 3)]
    public string Nombre { get; set; }
    
    [Required]
    [StringLength(500)]
    public string Descripcion { get; set; }
    
    [Range(0, double.MaxValue, ErrorMessage = "El stock m√≠nimo debe ser positivo")]
    public decimal StockMinimo { get; set; }
}
```

**Nivel 2: Validaci√≥n en Controllers**
```csharp
[HttpPost]
public async Task<ActionResult<IngredienteDto>> Crear([FromBody] CrearIngredienteCommand command)
{
    // ‚úÖ ASP.NET Core valida autom√°ticamente con [ApiController]
    // Si ModelState no es v√°lido, retorna 400 Bad Request autom√°ticamente
    
    // ‚úÖ Validaci√≥n adicional si se requiere
    if (command.StockMinimo > command.StockMaximo)
    {
        return BadRequest("El stock m√≠nimo no puede ser mayor al stock m√°ximo");
    }
    
    var resultado = await _mediator.Send(command);
    return CreatedAtAction(nameof(ObtenerPorId), new { id = resultado.Id }, resultado);
}
```

**Nivel 3: Validaci√≥n en Domain (Reglas de Negocio)**
```csharp
// Constructor de Ingrediente (Domain)
public Ingrediente(string nombre, string descripcion, UnidadDeMedida unidadDeMedida, ...)
{
    // ‚úÖ Validaciones de dominio
    if (string.IsNullOrWhiteSpace(nombre))
        throw new ArgumentException("El nombre no puede estar vac√≠o", nameof(nombre));
    
    if (nombre.Length > 100)
        throw new ArgumentException("El nombre no puede exceder 100 caracteres", nameof(nombre));
    
    // ...
}
```

**Niveles de Validaci√≥n**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Controller (API Boundary)                            ‚îÇ
‚îÇ    - Validaci√≥n de formato (Required, Range, etc.)     ‚îÇ
‚îÇ    - ModelState validation                              ‚îÇ
‚îÇ    - Retorna 400 Bad Request si falla                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 2. Application Handler                                  ‚îÇ
‚îÇ    - Validaci√≥n de l√≥gica de aplicaci√≥n                ‚îÇ
‚îÇ    - Validaci√≥n de relaciones entre datos               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 3. Domain                                               ‚îÇ
‚îÇ    - Validaci√≥n de reglas de negocio                    ‚îÇ
‚îÇ    - Protecci√≥n de invariantes                          ‚îÇ
‚îÇ    - Lanza excepciones de dominio                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Manejo de Errores de Validaci√≥n**:
```csharp
// ExceptionHandlingMiddleware.cs
public async Task InvokeAsync(HttpContext context, RequestDelegate next)
{
    try
    {
        await next(context);
    }
    catch (ArgumentException ex) // ‚úÖ Errores de validaci√≥n del Domain
    {
        context.Response.StatusCode = 400;
        await context.Response.WriteAsJsonAsync(new
        {
            error = "Datos inv√°lidos",
            message = ex.Message
        });
    }
    catch (InvalidOperationException ex) // ‚úÖ Errores de reglas de negocio
    {
        context.Response.StatusCode = 400;
        await context.Response.WriteAsJsonAsync(new
        {
            error = "Operaci√≥n inv√°lida",
            message = ex.Message
        });
    }
}
```

**Conclusi√≥n**: ‚úÖ **CUMPLE** - Validaci√≥n multi-nivel: API boundary, Application, y Domain.

---

## Resumen

La **Capa API** (Presentaci√≥n) act√∫a como la puerta de entrada a la aplicaci√≥n. Su responsabilidad principal es:

1. ‚úÖ Exponer endpoints REST HTTP
2. ‚úÖ Validar formato de datos de entrada
3. ‚úÖ Delegar procesamiento a la capa Application mediante MediatR
4. ‚úÖ Serializar respuestas a JSON
5. ‚úÖ Manejar errores de forma centralizada
6. ‚úÖ Documentar la API con Swagger

**No contiene l√≥gica de negocio** - Solo coordina y transforma datos entre HTTP y el dominio.

### üéØ Cumplimiento de Criterios de Evaluaci√≥n

| Criterio | Estado | Evidencia |
|----------|--------|-----------|
| **Controllers Delgados** | ‚úÖ **CUMPLE** | Solo coordinan, delegan a MediatR |
| **Manejo de Consistencia** | ‚úÖ **CUMPLE** | EF Core + Middleware manejan transacciones |
| **DTOs para Entrada/Salida** | ‚úÖ **CUMPLE** | Nunca exponen entidades de dominio |
| **Mapeo Expl√≠cito** | ‚úÖ **CUMPLE** | Handlers mapean manualmente entidad ‚Üî DTO |
| **Validaci√≥n en Boundaries** | ‚úÖ **CUMPLE** | Validaci√≥n multi-nivel (API, Application, Domain) |
